# IoT_MQTT 温度、湿度和气压数据发布与订阅系统

## 一、项目概述

**“IoT_MQTT 温度、湿度和气压数据发布与订阅系统”** 是同济大学软件学院物联网课程的期末项目，实现了基于 MQTT 协议的区域环境数据（温度、湿度、气压）发布订阅系统。系统通过 MQTT 协议进行传感器数据的传输，支持实时数据监控、历史数据可视化和未来数据预测功能。

### 项目特点
- 基于 MQTT 协议的可靠数据传输
- 实时数据监控与历史数据查询
- 环境数据（温度、湿度、气压）的预测功能
- 直观的 ECharts 数据可视化展示
- 完整的前后端分离架构

### 团队成员
同济大学23级软件工程 韦瑾钰 夏天 汤诚阳 李思远

## 二、系统架构与功能

### 1. 整体架构
系统采用经典的物联网数据传输架构：
- **数据采集层**：模拟传感器数据采集
- **传输层**：基于 MQTT 协议的消息队列
- **应用层**：Flask 后端 + HTML/ECharts 前端

### 2. 核心功能

#### 2.1 数据发布功能
- 支持随机数据发布
- 支持批量 CSV 数据发布
- 发布主题：温度、湿度、气压

#### 2.2 数据订阅功能
- 自定义 ClientID 订阅
- 多主题订阅管理
- 实时数据接收与显示

#### 2.3 数据可视化功能
- 实时数据图表展示
- 历史数据查询与分析
- 温度、湿度、气压分图表显示

#### 2.4 数据预测功能
- 基于历史数据的环境参数预测
- 真实值与预测值对比展示（红色曲线为真实数据，蓝色曲线为预测数据）
- 支持温度、湿度、气压三项参数的预测

## 三、项目文件结构

```
IoT_MQTT/
├── THPData/                  # 历史数据文件夹
├── forecast-data/            # 预测数据文件夹
├── img/                      # 项目图片资源
├── mqtt签名工具/              # MQTT签名工具
├── static/                   # 静态资源文件
├── templates/                # HTML模板文件
├── 数据包/                    # 原始数据包
├── MQTTClient.py            # MQTT客户端实现
├── publish_app.py           # 发布端应用
├── publish_module.py        # 发布端模块
├── subscribe_app.py         # 订阅端应用（核心修复文件）
├── subscribe_module.py      # 订阅端模块
├── README.md                # 项目说明文档
├── RUNNING_GUIDE.md         # 运行指南      
└── environment.yml          # 环境配置文件
```

## 四、安装与运行

### 4.1 环境要求
- Python 3.6 或更高版本
- 依赖库：paho-mqtt、pandas、flask
- Mosquitto MQTT 服务器

### 4.2 安装步骤

1. **克隆项目代码**
   ```bash
git clone https://github.com/LinWang1225/IoT_MQTT.git
cd IoT_MQTT
```

2. **安装并启动Mosquitto MQTT服务器**
   - Windows用户：
     1. 下载Mosquitto安装包：https://mosquitto.org/download/
     2. 运行安装程序，按照提示完成安装
     3. 安装完成后，Mosquitto服务会自动启动
   - Linux用户（以Ubuntu为例）：
     ```bash
     sudo apt-get update
     sudo apt-get install mosquitto mosquitto-clients
     sudo systemctl start mosquitto
     ```
   - 验证Mosquitto是否正常运行：
     ```bash
     mosquitto_sub -t test &
     mosquitto_pub -t test -m "hello world"
     ```

3. **创建虚拟环境**
   ```bash
conda env create -f environment.yml
conda activate THPSys
```

4. **安装依赖库**
   ```bash
pip install paho-mqtt pandas flask
```

### 4.3 运行项目

1. **确保Mosquitto服务器正在运行**
   - Windows用户：可在服务管理器中查看Mosquitto服务状态
   - Linux用户：使用命令 `sudo systemctl status mosquitto` 检查

2. **启动订阅端应用**
   ```bash
python subscribe_app.py
```

3. **启动发布端应用**
   ```bash
python publish_app.py
```

4. **访问 Web 界面**
   - 订阅端：http://127.0.0.1:5001/
   - 发布端：http://127.0.0.1:5000/

5. **使用预测功能**
   - 在订阅端登录成功后，访问预测页面
   - 查看温度、湿度、气压的真实数据与预测数据对比图表

## 五、API 接口说明

### 5.1 预测数据接口

**接口地址**：`/predict`
**请求方法**：GET
**返回格式**：JSON

**响应示例**：
```json
{
  "isSuccess": true,
  "data": [
    {
      "type": "temperature",
      "x_data": ["2014-02-13 06:00", "2014-02-13 07:00", ...],
      "ry_data": [25.6, 26.1, ...],  // 真实值
      "py_data": [25.8, 26.3, ...]   // 预测值
    },
    {
      "type": "humidity",
      "x_data": [...],
      "ry_data": [...],
      "py_data": [...]
    },
    {
      "type": "pressure",
      "x_data": [...],
      "ry_data": [...],
      "py_data": [...]
    }
  ]
}
```

### 5.2 历史数据接口

**接口地址**：`/chart`
**请求方法**：GET
**参数**：`variable`（可选，默认 temperature）
**返回格式**：JSON

## 六、数据文件说明

### 6.1 预测数据文件
位于 `forecast-data/` 目录下：
- `forecast_data_tem.csv`：温度预测数据
- `forecast_data_Hum.csv`：湿度预测数据
- `forecast_data_Pre.csv`：气压预测数据

数据格式：
```
month,day,hour,真实值,预测值
2,13,6,25.6,25.8
2,13,7,26.1,26.3
...
```

### 6.2 历史数据文件
位于 `THPData/` 目录下：
- `THP_data.csv`：综合环境数据
- `merged_data.csv`：合并后的历史数据

## 七、技术栈

- **后端框架**：Flask（Python）
- **消息协议**：MQTT
- **数据可视化**：ECharts
- **前端技术**：HTML/CSS/JavaScript、jQuery
- **数据处理**：pandas
- **部署平台**：Mosquitto MQTT 服务器

## 八、常见问题与解决方案

### 8.1 MQTT 连接失败
- 检查 Mosquitto 服务器是否正在运行
- 确认 MQTT 连接参数（主机名、端口、用户名密码等）正确
- 检查网络连接状态

### 8.2 预测数据显示异常
- 确认 `forecast-data/` 目录下的 CSV 文件存在且格式正确
- 检查 `subscribe_app.py` 中的文件路径配置
- 查看浏览器控制台的 JavaScript 错误

### 8.3 图表不显示
- 确认 ECharts 库加载成功
- 检查网络连接，确保能够正常访问 CDN 资源

## 九、项目总结

本项目成功实现了基于 MQTT 协议的环境数据发布订阅系统，具备完整的数据采集、传输、存储、可视化和预测功能。通过修复数据预测功能的文件路径问题，确保了预测数据能够正常显示，为用户提供了更全面的环境数据服务。

系统设计符合物联网应用的最佳实践，代码结构清晰，功能完善，可作为物联网应用开发的基础框架进行扩展和优化。